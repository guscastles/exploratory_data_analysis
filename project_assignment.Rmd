---
title: "Exploratory Data Analysis"
output: html_notebook
---
This is the project assignment for week 1 of the Exploratory Data Analysis course.

Some useful libraries
```{r}
library(tidyr)
library(dplyr)
library(lubridate)
```

The data set for this assignment can be fetched with the *download_data* function.
The url is

> https://d396qusza40orc.cloudfront.net/exdata%2Fdata%2Fhousehold_power_consumption.zip

```{r}
download_data <- function(url) {
        url_decoded <- URLdecode(url)
        dest_file <- tail(unlist(strsplit(url_decoded, "/")), 1)
        if (!file.exists(dest_file)) {
                download.file(url, destfile = dest_file)
                unzip(dest_file)
        }
        dest_file
}
```
Once the data file is available, the subset of interest is between years

> 2007-02-01 and 2007-02-02

This subset will be extracted using *fetch_data* function, from file

> household_power_consumption.txt

```{r}
fetch_data <- function(file_name) {
        
        change_datatypes <- function(data_set) {
                data_set["Date"] <- data_set %>%
                                      select(Date) %>%
                                      mutate(Date = dmy(Date))
                data_set["Time"] <- data_set %>%
                                      select(Time) %>%
                                      mutate(Time = as.POSIXct(strptime(Time, format = "%H:%M:%S")))
                data_set
        }
        
        change_columns <- function(data_set) {
                header <- read.delim("household_power_consumption.txt", nrows = 1,
                                     sep = ";", header = TRUE)
                colnames(data_set) <- colnames(header)
                data_set
        }
        
        dataset <- read.delim("household_power_consumption.txt", skip = 66637,
                              nrows = 2880, sep = ";", header = FALSE)
        dataset %>% change_columns %>% change_datatypes
}

```

The first plot
```{r}
first_plot <- function(dataset) {
        png(file = "plot1.png", width = 480, height = 480)
        hist(dataset$Global_active_power,
             col = "red",
             main = "Global Active Power",
             xlab = "Global Active Power (kilowatts)")
        dev.off()
}
```

The second plot
```{r}
create_labels <- function(date) {
        dates <- unique(date)
        first <- weekdays(dates[1], abbreviate = TRUE)
        middle <- weekdays(dates[ceiling(length(dates) / 2) + 1], abbreviate = TRUE)
        last <- weekdays(tail(dates, 1) + 1, abbreviate = TRUE)
        c(first, middle, last)
}

second_plot <- function(dataset) {
        png(file = "plot2.png", width = 480, height = 480)
        nrows <- dim(dataset)[1]
        hour_range <- 1:nrows
        plot(hour_range, dataset$Global_active_power, type = "n", xaxt = "n",
             ylab = "Global Active Power (kilowatts)", xlab = "")
        lines(hour_range, dataset$Global_active_power, type = "l")
        axis(1, at = c(1, floor(nrows / 2), nrows),
             labels = create_labels(as.Date(dataset$Date)), tick = TRUE)
        dev.off()
}
```
The third plot
```{r}
third_plot <- function(dataset) {
        png(file = "plot3.png", width = 480, height = 480)
        nrows <- dim(dataset)[1]
        hour_range <- 1:nrows
        plot(hour_range, dataset$Sub_metering_1, type = "n", xaxt = "n",
             ylab = "Enery sub metering", xlab = "")
        lines(hour_range, dataset$Sub_metering_1, type = "l")
        lines(hour_range, dataset$Sub_metering_2, type = "l", col = "red")
        lines(hour_range, dataset$Sub_metering_3, type = "l", col = "blue")
        legend("topright", legend = c("Sub_metering_1", "Sub_metering_2", "Sub_metering_3"),
               col = c("black", "red", "blue"), lty = c(1, 1, 1))
        axis(1, at = c(1, floor(nrows / 2), nrows), tick = TRUE,
             labels = create_labels(as.Date(dataset$Date)))
        dev.off()
}
```
The fourth plot
```{r}
fourth_plot <- function(dataset) {
        
}
```
Putting all together
```{r}
execute <- function() {
        url = "https://d396qusza40orc.cloudfront.net/exdata%2Fdata%2Fhousehold_power_consumption.zip"
        dest_file <- url %>% download_data
        dataset <- dest_file %>% fetch_data
        dataset %>% first_plot
        dataset %>% second_plot
        dataset %>% third_plot
        dataset %>% fourth_plot
        "Plots are done!"    
}

cat(execute())
```
